#include "memory.h"
#include "controller.h"
#include "cpu.h"
#include "io.h"

#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/ipc.h> 
#include <sys/shm.h> 
#include <fcntl.h>
#include <stdlib.h>
#include <pthread.h>

#define SCREEN_SIZE 1024
#define SCREEN_WIDTH 32

uint8_t game_code[] = {
    0x20, 0x06, 0x06, 0x20, 0x38, 0x06, 0x20, 0x0d, 0x06, 0x20, 0x2a, 0x06, 0x60, 0xa9, 0x02, 0x85,
    0x02, 0xa9, 0x04, 0x85, 0x03, 0xa9, 0x11, 0x85, 0x10, 0xa9, 0x10, 0x85, 0x12, 0xa9, 0x0f, 0x85,
    0x14, 0xa9, 0x04, 0x85, 0x11, 0x85, 0x13, 0x85, 0x15, 0x60, 0xa5, 0xfe, 0x85, 0x00, 0xa5, 0xfe,
    0x29, 0x03, 0x18, 0x69, 0x02, 0x85, 0x01, 0x60, 0x20, 0x4d, 0x06, 0x20, 0x8d, 0x06, 0x20, 0xc3,
    0x06, 0x20, 0x19, 0x07, 0x20, 0x20, 0x07, 0x20, 0x2d, 0x07, 0x4c, 0x38, 0x06, 0xa5, 0xff, 0xc9,
    0x77, 0xf0, 0x0d, 0xc9, 0x64, 0xf0, 0x14, 0xc9, 0x73, 0xf0, 0x1b, 0xc9, 0x61, 0xf0, 0x22, 0x60,
    0xa9, 0x04, 0x24, 0x02, 0xd0, 0x26, 0xa9, 0x01, 0x85, 0x02, 0x60, 0xa9, 0x08, 0x24, 0x02, 0xd0,
    0x1b, 0xa9, 0x02, 0x85, 0x02, 0x60, 0xa9, 0x01, 0x24, 0x02, 0xd0, 0x10, 0xa9, 0x04, 0x85, 0x02,
    0x60, 0xa9, 0x02, 0x24, 0x02, 0xd0, 0x05, 0xa9, 0x08, 0x85, 0x02, 0x60, 0x60, 0x20, 0x94, 0x06,
    0x20, 0xa8, 0x06, 0x60, 0xa5, 0x00, 0xc5, 0x10, 0xd0, 0x0d, 0xa5, 0x01, 0xc5, 0x11, 0xd0, 0x07,
    0xe6, 0x03, 0xe6, 0x03, 0x20, 0x2a, 0x06, 0x60, 0xa2, 0x02, 0xb5, 0x10, 0xc5, 0x10, 0xd0, 0x06,
    0xb5, 0x11, 0xc5, 0x11, 0xf0, 0x09, 0xe8, 0xe8, 0xe4, 0x03, 0xf0, 0x06, 0x4c, 0xaa, 0x06, 0x4c,
    0x35, 0x07, 0x60, 0xa6, 0x03, 0xca, 0x8a, 0xb5, 0x10, 0x95, 0x12, 0xca, 0x10, 0xf9, 0xa5, 0x02,
    0x4a, 0xb0, 0x09, 0x4a, 0xb0, 0x19, 0x4a, 0xb0, 0x1f, 0x4a, 0xb0, 0x2f, 0xa5, 0x10, 0x38, 0xe9,
    0x20, 0x85, 0x10, 0x90, 0x01, 0x60, 0xc6, 0x11, 0xa9, 0x01, 0xc5, 0x11, 0xf0, 0x28, 0x60, 0xe6,
    0x10, 0xa9, 0x1f, 0x24, 0x10, 0xf0, 0x1f, 0x60, 0xa5, 0x10, 0x18, 0x69, 0x20, 0x85, 0x10, 0xb0,
    0x01, 0x60, 0xe6, 0x11, 0xa9, 0x06, 0xc5, 0x11, 0xf0, 0x0c, 0x60, 0xc6, 0x10, 0xa5, 0x10, 0x29,
    0x1f, 0xc9, 0x1f, 0xf0, 0x01, 0x60, 0x4c, 0x35, 0x07, 0xa0, 0x00, 0xa5, 0xfe, 0x91, 0x00, 0x60,
    0xa6, 0x03, 0xa9, 0x00, 0x81, 0x10, 0xa2, 0x00, 0xa9, 0x01, 0x81, 0x10, 0x60, 0xa2, 0x00, 0xea,
    0xea, 0xca, 0xd0, 0xfb, 0x60
};

int main(int argc, char* argv[]) {
    (void)argc;
    (void)argv;

    union memory_union* memory = (union memory_union*)malloc(sizeof(union memory_union));
    memory_init(memory);
    memory_set_at(memory, 0x600, game_code, sizeof(game_code));
    memory_set_startup_vector(memory, 0x600);

    struct cpu cpu;
    cpu_init(&cpu, memory);
    cpu_reset(&cpu);


    uint8_t *random_map = &(memory->raw[0xFE]);
    uint8_t *controller_map = &(memory->raw[0xFF]);
    uint8_t *screen_map = &(memory->raw[0x200]);

    key_t key1;

    if (-1 != open("/tmp/data", O_CREAT, 0777)) {
        key1 = ftok("/tmp/data", 0);
     } else {
        perror("open");
        exit(1);
    }

    int id1 = shmget(key1, 0x1000, IPC_CREAT | SHM_R | SHM_W);
    uint8_t * controller_reader = shmat(id1,0,0);

    while (!get_flag(&cpu, BREAK)) {
        if (*controller_reader == 'w' || *controller_reader == 's' || *controller_reader == 'a' || *controller_reader == 'd')
            *controller_map = *controller_reader;
        *random_map = rand() % 256;

        //int ignored = system("clear");
        //(void)ignored;

        cpu_act(&cpu, 1);

        for (uint16_t y = 0; y < SCREEN_SIZE; y++) {
            if (y > 0 && (y % SCREEN_WIDTH == 0))
                printf("\n");
            switch (screen_map[y]) {
                case 0:
                    printf("[ ]");
                    break;
                case 4:
                    printf("[@]");
                    break;
                case 3:
                    printf("[X]");
                    break;
                default:
                    printf("[?]");
                    break;
            }
        }
        printf("\n");
        
        printf("CTRL: %02x | PRNG: %02x\n", *controller_map, *random_map);
        usleep(100000);
    }
}